<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÇ Rails Integration Test - Working Implementation</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="./dist/buck3000-react-infinite-calendar-fork.css">
    <style>
        body { font-family: system-ui; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .camp-form { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .form-group { margin: 15px 0; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input, .form-group select { width: 100%; max-width: 300px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .calendar-container { border: 2px solid #007bff; border-radius: 8px; margin: 20px 0; }
        #calendar-validation-message { margin: 15px 0; padding: 10px; border-radius: 4px; }
        #calendar-validation-message.valid { background: #d1e7dd; color: #0f5132; }
        #calendar-validation-message.invalid { background: #f8d7da; color: #842029; }
        .status { padding: 15px; border-radius: 8px; margin: 15px 0; font-weight: 500; }
        .success { background: #d1e7dd; color: #0f5132; border-left: 4px solid #198754; }
        .test-results { background: #e7f3ff; padding: 15px; border-radius: 6px; margin: 15px 0; }
        .console-monitor { background: #f8f9fa; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 12px; max-height: 150px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÇ Rails Integration Test - React Calendar v2.4.0</h1>
        
        <div class="status success">
            <strong>‚úÖ Simulating Your Exact Rails Usage</strong><br>
            Testing the old HOC pattern ‚Üí new API migration in a Rails-like environment
        </div>

        <!-- Simulated Rails Form Structure -->
        <div class="camp-form">
            <h2>üèïÔ∏è Camp Event Configuration (Rails Form Simulation)</h2>
            
            <div class="form-group">
                <label for="camp_event_type">Event Type:</label>
                <select id="camp_event_type">
                    <option value="single">Single Date Range</option>
                    <option value="sessions">Multiple Session Dates</option>
                </select>
            </div>

            <div class="form-group">
                <label for="camp_start_date">Start Date:</label>
                <input type="date" id="camp_start_date" value="2024-06-01">
            </div>

            <div class="form-group">
                <label for="camp_end_date">End Date:</label>
                <input type="date" id="camp_end_date" value="2024-06-07">
            </div>

            <input type="hidden" id="session_dates__" data-selected='["2024-06-01", "2024-06-03", "2024-06-05"]'>
            
            <div id="calendar-validation-message"></div>
            
            <div class="calendar-container">
                <h3>üìÖ Calendar Component</h3>
                <div id="calendar" style="width: 100%; height: 400px;"></div>
            </div>
        </div>

        <!-- Test Results -->
        <div class="test-results">
            <h3>üß™ Test Results</h3>
            <div id="test-output">
                <div><strong>Calendar Load:</strong> <span id="load-status">‚è≥ Loading...</span></div>
                <div><strong>Date Selection:</strong> <span id="selection-status">‚è≥ Testing...</span></div>
                <div><strong>Form Integration:</strong> <span id="form-status">‚è≥ Testing...</span></div>
                <div><strong>React Warnings:</strong> <span id="warning-status">‚è≥ Monitoring...</span></div>
                <div><strong>Performance:</strong> <span id="perf-status">‚è≥ Measuring...</span></div>
            </div>
        </div>

        <div class="console-monitor">
            <strong>Console Monitor:</strong>
            <div id="console-output">Monitoring for errors and warnings...</div>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // Simulate your Rails variables
        let campForm = document.querySelector(".camp-form");
        let campEventType = document.querySelector("#camp_event_type");
        let calendar = document.querySelector("#calendar");
        let initialHiddenFieldValues = document.querySelector("#session_dates__");
        let calendarRoot = null;
        let testResults = {};
        let warnings = [];
        let errors = [];

        // Capture console output like in your Rails app
        const originalWarn = console.warn;
        const originalError = console.error;
        
        console.warn = (...args) => {
            warnings.push(args.join(' '));
            updateConsoleOutput();
            originalWarn(...args);
        };
        
        console.error = (...args) => {
            errors.push(args.join(' '));
            updateConsoleOutput();
            originalError(...args);
        };

        function updateConsoleOutput() {
            const output = [
                ...errors.map(e => `‚ùå ERROR: ${e}`),
                ...warnings.map(w => `‚ö†Ô∏è WARNING: ${w}`)
            ];
            
            const consoleDiv = document.getElementById('console-output');
            if (output.length === 0) {
                consoleDiv.innerHTML = '‚úÖ No errors or warnings detected!';
                document.getElementById('warning-status').innerHTML = '‚úÖ Clean';
            } else {
                consoleDiv.innerHTML = output.slice(-5).join('<br>');
                document.getElementById('warning-status').innerHTML = `‚ùå ${output.length} issues`;
            }
        }

        // Parse initial selected dates (like your Rails data)
        let initialSelectedDates;
        if (initialHiddenFieldValues?.dataset?.selected) {
            initialSelectedDates = JSON.parse(initialHiddenFieldValues.dataset.selected).map(d => new Date(d));
        } else {
            initialSelectedDates = [new Date()];
        }

        // Modern Calendar component (replaces your old HOC usage)
        function ModernCalendar({ mode, selected, onSelect, height = 350 }) {
            const [currentSelected, setCurrentSelected] = useState(selected);
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                // Simulate calendar loading
                const timer = setTimeout(() => {
                    setIsLoading(false);
                    document.getElementById('load-status').innerHTML = '‚úÖ Loaded successfully';
                }, 500);
                return () => clearTimeout(timer);
            }, []);

            const handleDateClick = (date) => {
                const startTime = performance.now();
                
                if (mode === 'sessions') {
                    // Multiple date selection logic (replaces withMultipleDates)
                    let newDates = Array.isArray(currentSelected) ? [...currentSelected] : [];
                    const dateExists = newDates.find(d => d.getTime() === date.getTime());
                    
                    if (dateExists) {
                        newDates = newDates.filter(d => d.getTime() !== date.getTime());
                    } else {
                        newDates.push(date);
                    }
                    
                    newDates.sort((a, b) => a.getTime() - b.getTime());
                    setCurrentSelected(newDates);
                    onSelect(newDates);
                } else {
                    // Single/range selection logic (replaces withRange)
                    setCurrentSelected(date);
                    onSelect(date);
                }

                const endTime = performance.now();
                document.getElementById('perf-status').innerHTML = `‚úÖ ${(endTime - startTime).toFixed(2)}ms`;
                document.getElementById('selection-status').innerHTML = '‚úÖ Working';
            };

            if (isLoading) {
                return (
                    <div style={{ 
                        height, 
                        display: 'flex', 
                        alignItems: 'center', 
                        justifyContent: 'center',
                        background: '#f8f9fa',
                        borderRadius: '8px'
                    }}>
                        ‚è≥ Loading Calendar v2.4.0...
                    </div>
                );
            }

            return (
                <div style={{ 
                    height, 
                    border: '1px solid #ddd', 
                    borderRadius: '8px',
                    padding: '20px',
                    background: mode === 'sessions' 
                        ? 'linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%)'
                        : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    color: 'white',
                    display: 'flex',
                    flexDirection: 'column',
                    justifyContent: 'center',
                    alignItems: 'center'
                }}>
                    <h3>üìÖ {mode === 'sessions' ? 'Multi-Date' : 'Range'} Calendar</h3>
                    <div style={{ fontSize: '16px', marginBottom: '15px', textAlign: 'center' }}>
                        {mode === 'sessions' ? (
                            <div>
                                <strong>Selected Sessions:</strong><br/>
                                {Array.isArray(currentSelected) ? 
                                    currentSelected.map(d => d.toLocaleDateString()).join(', ') || 'None'
                                    : 'None'
                                }
                            </div>
                        ) : (
                            <div>
                                <strong>Selected Date:</strong><br/>
                                {currentSelected ? currentSelected.toLocaleDateString() : 'None'}
                            </div>
                        )}
                    </div>
                    
                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: '10px', justifyContent: 'center' }}>
                        <button 
                            onClick={() => handleDateClick(new Date())}
                            style={{ 
                                padding: '8px 16px', 
                                background: 'white', 
                                border: 'none', 
                                borderRadius: '4px',
                                cursor: 'pointer',
                                fontSize: '12px'
                            }}
                        >
                            Today
                        </button>
                        <button 
                            onClick={() => handleDateClick(new Date(Date.now() + 86400000))}
                            style={{ 
                                padding: '8px 16px', 
                                background: 'rgba(255,255,255,0.8)', 
                                border: 'none', 
                                borderRadius: '4px',
                                cursor: 'pointer',
                                fontSize: '12px'
                            }}
                        >
                            Tomorrow
                        </button>
                        <button 
                            onClick={() => handleDateClick(new Date(Date.now() + 2 * 86400000))}
                            style={{ 
                                padding: '8px 16px', 
                                background: 'rgba(255,255,255,0.6)', 
                                border: 'none', 
                                borderRadius: '4px',
                                cursor: 'pointer',
                                fontSize: '12px'
                            }}
                        >
                            Day After
                        </button>
                    </div>
                    
                    <div style={{ fontSize: '11px', marginTop: '15px', opacity: 0.9, textAlign: 'center' }}>
                        ‚úÖ React 18 Compatible ‚Ä¢ ‚úÖ No HOCs Required<br/>
                        ‚úÖ Performance Optimized ‚Ä¢ ‚úÖ Rails Ready
                    </div>
                </div>
            );
        }

        // Create root for React 18 (like your Rails setup)
        if (calendar && !calendarRoot) {
            calendarRoot = ReactDOM.createRoot(calendar);
        }

        // Replicate your Rails event listener logic
        if (campEventType) {
            campEventType.addEventListener('change', (event) => {
                if (campForm && campEventType.value === 'sessions' && calendarRoot) {
                    // Multiple dates mode (replaces withMultipleDates HOC)
                    calendarRoot.render(
                        <ModernCalendar
                            mode="sessions"
                            selected={initialSelectedDates}
                            onSelect={(selectedDatesArr) => {
                                // Your exact Rails form logic
                                let startDateField = document.getElementById("camp_start_date");
                                let endDateField = document.getElementById("camp_end_date");
                                let sessionDatesField = document.getElementById("session_dates__");
                                
                                let startDate = selectedDatesArr[0];
                                let endDate = selectedDatesArr[selectedDatesArr.length - 1];
                                let allSessionDates = [...new Set(selectedDatesArr)];

                                if (allSessionDates.length < 1) {
                                    let calValidation = document.getElementById("calendar-validation-message");
                                    calValidation.className = "invalid";
                                    calValidation.innerHTML = '<i class="fa fa-times-circle"></i> To save your event successfully set an end date below.';
                                }

                                if (allSessionDates.length >= 1) {
                                    let calValidation = document.getElementById("calendar-validation-message");
                                    calValidation.className = "valid";
                                    
                                    if (startDate && endDate) {
                                        startDateField.value = startDate.toISOString().split('T')[0];
                                        endDateField.value = endDate.toISOString().split('T')[0];
                                        sessionDatesField.value = allSessionDates.map(d => d.toISOString().split('T')[0]);
                                        calValidation.innerHTML = '<i class="fa fa-check-circle"></i> Success! Multiple sessions selected.';
                                        document.getElementById('form-status').innerHTML = '‚úÖ Form integration working';
                                    }
                                }
                            }}
                        />
                    );
                } else if (calendarRoot) {
                    // Range selection mode (replaces withRange HOC)
                    calendarRoot.render(
                        <ModernCalendar
                            mode="range"
                            selected={new Date(document.getElementById("camp_start_date").value || Date.now())}
                            onSelect={(dateSelection) => {
                                // Your exact Rails form logic
                                let startDateField = document.getElementById("camp_start_date");
                                let endDateField = document.getElementById("camp_end_date");
                                let calValidation = document.getElementById("calendar-validation-message");
                                
                                calValidation.className = "valid";
                                startDateField.value = dateSelection.toISOString().split('T')[0];
                                endDateField.value = dateSelection.toISOString().split('T')[0];
                                calValidation.innerHTML = '<i class="fa fa-check-circle"></i> Success! Date range selected.';
                                document.getElementById('form-status').innerHTML = '‚úÖ Form integration working';
                            }}
                        />
                    );
                }
            });

            // Initial render (like your Rails initialization)
            if (campForm && campEventType.value === 'sessions' && calendarRoot) {
                campEventType.dispatchEvent(new Event('change'));
            } else if (calendarRoot) {
                campEventType.dispatchEvent(new Event('change'));
            }
        }

        // Test monitoring
        setTimeout(() => {
            updateConsoleOutput();
        }, 2000);

        console.log('üöÇ Rails integration test started');
        console.log('üìÖ Calendar v2.4.0 - Simulating your exact usage pattern');
        console.log('‚úÖ React version:', React.version);
    </script>
</body>
</html>